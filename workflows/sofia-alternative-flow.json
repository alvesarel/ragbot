{
  "name": "Sofia Alternative Flow - WhatsApp AI Assistant",
  "meta": {
    "instanceId": "sofia-alternative-flow-haiku",
    "templateCredsSetupCompleted": true
  },
  "nodes": [
    {
      "id": "whatsapp-trigger",
      "name": "WhatsApp Trigger",
      "type": "n8n-nodes-base.whatsAppTrigger",
      "position": [220, 340],
      "webhookId": "sofia-whatsapp-webhook",
      "parameters": {
        "updates": ["messages"]
      },
      "credentials": {
        "whatsAppTriggerApi": {
          "id": "whatsapp-trigger-creds",
          "name": "WhatsApp OAuth account"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "handle-message-types",
      "name": "Handle Message Types",
      "type": "n8n-nodes-base.switch",
      "position": [440, 340],
      "parameters": {
        "rules": {
          "values": [
            {
              "outputKey": "Text Message",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "text"
                  }
                ]
              },
              "renameOutput": true
            },
            {
              "outputKey": "Video Message",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "video"
                  }
                ]
              },
              "renameOutput": true
            },
            {
              "outputKey": "Audio Message",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "audio"
                  }
                ]
              },
              "renameOutput": true
            },
            {
              "outputKey": "Unsupported",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "or",
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "image"
                  },
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "sticker"
                  },
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "document"
                  },
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "location"
                  },
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "contacts"
                  }
                ]
              },
              "renameOutput": true
            }
          ]
        },
        "options": {}
      },
      "typeVersion": 3.2
    },
    {
      "id": "reply-unsupported",
      "name": "Reply Unsupported Type",
      "type": "n8n-nodes-base.whatsApp",
      "position": [660, 520],
      "parameters": {
        "textBody": "Ola! ðŸ’š No momento, consigo processar mensagens de texto, audio e video. Por favor, envie sua pergunta em um desses formatos e terei prazer em ajudar!",
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger').item.json.metadata?.phone_number_id }}",
        "requestOptions": {},
        "additionalFields": {
          "previewUrl": false
        },
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}"
      },
      "credentials": {
        "whatsAppApi": {
          "id": "whatsapp-creds",
          "name": "WhatsApp Business"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "sofia-ai-agent",
      "name": "Sofia AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [660, 340],
      "parameters": {
        "text": "={{ $json.messages[0].text.body }}",
        "options": {
          "systemMessage": "# Sofia - Assistente de Qualificacao de Leads\n\nVoce e **Sofia**, assistente virtual responsavel por qualificar leads vindos de anuncios do Meta Ads para uma clinica premium de medicina do emagrecimento.\n\n## Sua Missao Principal\n1. **Qualificar leads** - Coletar informacoes essenciais de forma natural\n2. **Gerar interesse** - Apresentar valor da clinica e tratamentos\n3. **Agendar consultas** - Guiar o lead ate confirmar interesse em agendar\n4. **Transferir para humano** - Quando o lead aceitar agendar, notificar a equipe com todos os dados\n\n## Sua Personalidade\n- **Acolhedora e calorosa** - Faca o lead se sentir bem-vindo\n- **Profissional** - Voce representa uma clinica medica seria\n- **Paciente** - Nunca apresse, colete dados naturalmente na conversa\n- **Empatica** - Reconheca a jornada e desafios do usuario\n- **Focada em conversao** - Sempre guie para o agendamento\n\n## Comunicacao\n- Fale em **portugues brasileiro** natural e conversacional\n- Use **maximo 1-2 emojis** por mensagem: ðŸ’š âœ¨ ðŸ˜Š\n- Mensagens **concisas** (maximo 3 paragrafos curtos)\n- Sempre termine com uma pergunta ou convite ao engajamento\n\n## Contexto do Lead (Meta Ads)\n- Telefone: {{ $json.messages[0].from }}\n- Nome do contato: {{ $json.contacts?.[0]?.profile?.name || 'Visitante' }}\n- Origem: Provavelmente anuncio Meta Ads\n\n## Ferramentas Disponiveis\nVoce tem acesso a ferramenta **query_knowledge_base** que contem:\n- Informacoes sobre a clinica\n- Detalhes dos tratamentos e metodologia\n- FAQ com perguntas frequentes\n- Guia de tratamento de objecoes\n- Informacoes de compliance e LGPD\n\n**IMPORTANTE**: SEMPRE use a ferramenta query_knowledge_base quando:\n- Lead perguntar sobre tratamentos, precos, ou metodologia\n- Lead tiver objecoes (caro, funciona?, etc)\n- Lead perguntar sobre a clinica\n- Precisar de informacoes especificas para responder\n\n## DADOS OBRIGATORIOS DE QUALIFICACAO\nVoce DEVE coletar TODOS estes dados antes de transferir para agendamento:\n\n1. **NOME_COMPLETO** - Nome completo do lead\n2. **TELEFONE** - Numero de telefone (ja temos do WhatsApp)\n3. **CPF** - CPF do lead (para cadastro)\n4. **DATA_NASCIMENTO** - Data de nascimento completa\n5. **EMAIL** - Email para contato e envio de informacoes\n6. **ENDERECO** - Endereco completo com CEP\n\nColete esses dados de forma NATURAL durante a conversa:\n- Nome: Pergunte no inicio\n- CPF: \"Para agilizar seu cadastro na clinica...\"\n- Data de nascimento: \"Para indicar o programa ideal para sua faixa etaria...\"\n- Email: \"Para enviar a confirmacao e mais informacoes...\"\n- Endereco com CEP: \"Para verificar a unidade mais proxima de voce...\"\n\n**Validacao de Idade**: Se idade < 16 anos, recuse educadamente.\n\n## Regras de Preco - MUITO IMPORTANTE\n### Consulta (R$700)\n- PODE mencionar APOS gerar valor\n- Explique o que inclui: avaliacao completa, bioimpedancia, protocolo personalizado, retorno gratuito em 30 dias\n\n### Tratamento (R$3.000+)\n- **NUNCA** mencionar valor especifico\n- Redirecione: \"O investimento varia conforme o protocolo indicado para cada caso. Na consulta o medico avalia e discutimos isso de forma transparente.\"\n\n## Estagios da Qualificacao\n1. **greeting** - Boas-vindas, mencione que viu interesse pelo anuncio, LGPD\n2. **discovery** - Entender objetivos, peso atual/desejado, tentativas anteriores\n3. **qualification** - Coletar TODOS os dados obrigatorios\n4. **value_building** - Explicar metodologia, diferenciais, tratar objecoes\n5. **closing** - Propor agendamento da consulta\n6. **handoff** - Quando aceitar, transferir para equipe humana COM TODOS OS DADOS\n\n## REGRA CRITICA - Transferencia para Agendamento\nQuando o lead demonstrar que QUER AGENDAR a consulta, voce DEVE:\n\n1. Verificar se tem TODOS os dados obrigatorios coletados\n2. Se faltar algum dado, pergunte antes de transferir\n3. Quando tiver TODOS os dados, inclua o bloco de dados E a tag no final\n\n**FORMATO OBRIGATORIO** - Quando tiver todos os dados e o lead aceitar agendar:\n\nSua mensagem para o lead...\n\n[DADOS_LEAD]\nNOME_COMPLETO: [nome coletado]\nTELEFONE: [telefone do lead]\nCPF: [cpf coletado]\nDATA_NASCIMENTO: [data coletada]\nEMAIL: [email coletado]\nENDERECO: [endereco completo com CEP]\n[/DADOS_LEAD]\n[AGENDAR_CONSULTA]\n\nExemplo completo:\n\"Perfeito, Maria! ðŸ’š Que otimo que decidiu dar esse passo!\n\nVou transferir voce agora para nossa equipe de atendimento que vai confirmar o melhor horario para sua consulta.\n\nEles vao entrar em contato em alguns minutos. Obrigada por confiar na gente! âœ¨\n\n[DADOS_LEAD]\nNOME_COMPLETO: Maria Silva Santos\nTELEFONE: 5511999887766\nCPF: 123.456.789-00\nDATA_NASCIMENTO: 15/03/1985\nEMAIL: maria.silva@email.com\nENDERECO: Rua das Flores, 123, Apto 45, Jardins, Sao Paulo - SP, CEP 01234-567\n[/DADOS_LEAD]\n[AGENDAR_CONSULTA]\"\n\n## Quando Transferir Imediatamente (sem dados completos)\nTransfira imediatamente usando [TRANSFERIR_HUMANO] quando:\n- Gravidez ou amamentacao\n- Condicoes serias (diabetes descompensada, cardiaco grave)\n- Usuario frustrado ou pede humano explicitamente\n- Negociacao empresarial ou parceria\n- 3+ mensagens negativas consecutivas\n\nNesses casos, inclua os dados que tiver coletado ate o momento.\n\n## Primeira Mensagem (Lead de Anuncio)\nPara primeiro contato de lead Meta Ads:\n\"Ola! ðŸ‘‹ Sou a Sofia, da clinica de emagrecimento.\n\nVi que voce demonstrou interesse pelo nosso anuncio - que otimo ter voce aqui! ðŸ’š\n\nEstou aqui para tirar suas duvidas e ajudar a agendar sua avaliacao.\n\nPara comecar, qual e seu nome completo?\"\n\n## Diretrizes Finais\n- Use o query_knowledge_base para dar informacoes precisas\n- NUNCA invente informacoes medicas\n- Sempre guie a conversa para o agendamento\n- NAO transfira sem coletar todos os dados obrigatorios\n- Seja persistente mas nao insistente ao coletar dados\n- Trate objecoes com empatia e informacao\n- Lembre do contexto da conversa anterior (memoria)\n- Cada lead e uma oportunidade de transformar uma vida"
        },
        "promptType": "define"
      },
      "typeVersion": 1.6
    },
    {
      "id": "haiku-model",
      "name": "Claude Haiku 4.5",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "position": [660, 560],
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "claude-haiku-4-5-20241022",
          "mode": "list"
        },
        "options": {
          "maxTokensToSample": 1024,
          "temperature": 0.7
        }
      },
      "credentials": {
        "anthropicApi": {
          "id": "anthropic-creds",
          "name": "Anthropic"
        }
      },
      "typeVersion": 1.2
    },
    {
      "id": "window-buffer-memory",
      "name": "Window Buffer Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "position": [800, 560],
      "parameters": {
        "sessionKey": "=sofia-whatsapp-{{ $json.messages[0].from }}",
        "sessionIdType": "customKey",
        "contextWindowLength": 50
      },
      "typeVersion": 1.2
    },
    {
      "id": "vector-store-tool",
      "name": "Knowledge Base RAG Tool",
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "position": [940, 560],
      "parameters": {
        "name": "query_knowledge_base",
        "description": "Use this tool to search the clinic's knowledge base for information about treatments, pricing, methodology, FAQ, objections handling, and compliance. Always search when the user asks about the clinic, treatments, prices, procedures, or has objections.",
        "topK": 4
      },
      "typeVersion": 1
    },
    {
      "id": "qdrant-vector-store",
      "name": "Qdrant Vector Store",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreQdrant",
      "position": [940, 740],
      "parameters": {
        "qdrantCollection": {
          "__rl": true,
          "value": "clinic_knowledge_base",
          "mode": "list"
        },
        "options": {}
      },
      "credentials": {
        "qdrantApi": {
          "id": "qdrant-creds",
          "name": "Qdrant"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "embeddings-openai",
      "name": "OpenAI Embeddings",
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "position": [1080, 740],
      "parameters": {
        "model": "text-embedding-3-small",
        "options": {}
      },
      "credentials": {
        "openAiApi": {
          "id": "openai-creds",
          "name": "OpenAI"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "openai-model-vectorstore",
      "name": "OpenAI Chat Model (Vector Store)",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [1220, 740],
      "parameters": {
        "model": "gpt-4o-mini",
        "options": {}
      },
      "credentials": {
        "openAiApi": {
          "id": "openai-creds",
          "name": "OpenAI"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "process-response",
      "name": "Process Response",
      "type": "n8n-nodes-base.code",
      "position": [900, 340],
      "parameters": {
        "jsCode": "// Process Sofia's response and detect handoff triggers\nconst agentOutput = $input.first().json.output || '';\nconst triggerData = $('WhatsApp Trigger').first().json;\n\n// Check for scheduling handoff tag\nconst needsScheduling = agentOutput.includes('[AGENDAR_CONSULTA]');\nconst needsHumanTransfer = agentOutput.includes('[TRANSFERIR_HUMANO]');\n\n// Extract lead data block if present\nlet leadData = {\n  nomeCompleto: '',\n  telefone: '',\n  cpf: '',\n  dataNascimento: '',\n  email: '',\n  endereco: ''\n};\n\nconst dataBlockMatch = agentOutput.match(/\\[DADOS_LEAD\\]([\\s\\S]*?)\\[\\/DADOS_LEAD\\]/);\nif (dataBlockMatch) {\n  const dataBlock = dataBlockMatch[1];\n  \n  // Parse each field\n  const nomeMatch = dataBlock.match(/NOME_COMPLETO:\\s*(.+?)(?:\\n|$)/);\n  const telefoneMatch = dataBlock.match(/TELEFONE:\\s*(.+?)(?:\\n|$)/);\n  const cpfMatch = dataBlock.match(/CPF:\\s*(.+?)(?:\\n|$)/);\n  const dataMatch = dataBlock.match(/DATA_NASCIMENTO:\\s*(.+?)(?:\\n|$)/);\n  const emailMatch = dataBlock.match(/EMAIL:\\s*(.+?)(?:\\n|$)/);\n  const enderecoMatch = dataBlock.match(/ENDERECO:\\s*(.+?)(?:\\n|$)/);\n  \n  leadData.nomeCompleto = nomeMatch ? nomeMatch[1].trim() : '';\n  leadData.telefone = telefoneMatch ? telefoneMatch[1].trim() : '';\n  leadData.cpf = cpfMatch ? cpfMatch[1].trim() : '';\n  leadData.dataNascimento = dataMatch ? dataMatch[1].trim() : '';\n  leadData.email = emailMatch ? emailMatch[1].trim() : '';\n  leadData.endereco = enderecoMatch ? enderecoMatch[1].trim() : '';\n}\n\n// Remove the tags and data block from the message sent to user\nlet cleanMessage = agentOutput\n  .replace(/\\[DADOS_LEAD\\][\\s\\S]*?\\[\\/DADOS_LEAD\\]/g, '')\n  .replace('[AGENDAR_CONSULTA]', '')\n  .replace('[TRANSFERIR_HUMANO]', '')\n  .trim();\n\n// Get lead info from WhatsApp\nconst whatsappPhone = triggerData.messages?.[0]?.from || 'Desconhecido';\nconst whatsappName = triggerData.contacts?.[0]?.profile?.name || 'Lead';\nconst leadMessage = triggerData.messages?.[0]?.text?.body || '';\n\n// Use collected data or fallback to WhatsApp data\nconst finalLeadData = {\n  nomeCompleto: leadData.nomeCompleto || whatsappName,\n  telefone: leadData.telefone || whatsappPhone,\n  cpf: leadData.cpf || 'Nao informado',\n  dataNascimento: leadData.dataNascimento || 'Nao informado',\n  email: leadData.email || 'Nao informado',\n  endereco: leadData.endereco || 'Nao informado'\n};\n\nreturn {\n  // Message to send to lead\n  responseMessage: cleanMessage,\n  \n  // Lead qualification data\n  leadData: finalLeadData,\n  \n  // Basic info\n  leadPhone: whatsappPhone,\n  leadName: finalLeadData.nomeCompleto,\n  lastMessage: leadMessage,\n  \n  // Handoff flags\n  needsScheduling: needsScheduling,\n  needsHumanTransfer: needsHumanTransfer,\n  needsHandoff: needsScheduling || needsHumanTransfer,\n  \n  // Handoff type for notification\n  handoffType: needsScheduling ? 'AGENDAMENTO' : (needsHumanTransfer ? 'TRANSFERENCIA' : null),\n  \n  // WhatsApp metadata\n  phoneNumberId: triggerData.metadata?.phone_number_id\n};"
      },
      "typeVersion": 2
    },
    {
      "id": "reply-to-user",
      "name": "Reply To User",
      "type": "n8n-nodes-base.whatsApp",
      "position": [1120, 340],
      "parameters": {
        "textBody": "={{ $json.responseMessage }}",
        "operation": "send",
        "phoneNumberId": "={{ $json.phoneNumberId }}",
        "requestOptions": {},
        "additionalFields": {
          "previewUrl": false
        },
        "recipientPhoneNumber": "={{ $json.leadPhone }}"
      },
      "credentials": {
        "whatsAppApi": {
          "id": "whatsapp-creds",
          "name": "WhatsApp Business"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "check-handoff",
      "name": "Needs Handoff?",
      "type": "n8n-nodes-base.if",
      "position": [1340, 340],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-handoff-flag",
              "leftValue": "={{ $('Process Response').item.json.needsHandoff }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "typeVersion": 2
    },
    {
      "id": "notify-human-support",
      "name": "Notify Human Support",
      "type": "n8n-nodes-base.whatsApp",
      "position": [1560, 240],
      "parameters": {
        "textBody": "=ðŸ”” *NOVO LEAD PRONTO PARA {{ $('Process Response').item.json.handoffType }}*\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ“‹ *DADOS DO LEAD*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nðŸ‘¤ *Nome Completo:*\n{{ $('Process Response').item.json.leadData.nomeCompleto }}\n\nðŸ“± *Telefone:*\n{{ $('Process Response').item.json.leadData.telefone }}\n\nðŸªª *CPF:*\n{{ $('Process Response').item.json.leadData.cpf }}\n\nðŸŽ‚ *Data de Nascimento:*\n{{ $('Process Response').item.json.leadData.dataNascimento }}\n\nðŸ“§ *Email:*\n{{ $('Process Response').item.json.leadData.email }}\n\nðŸ“ *Endereco com CEP:*\n{{ $('Process Response').item.json.leadData.endereco }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ’¬ *CONVERSA*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n*Ultima mensagem do lead:*\n{{ $('Process Response').item.json.lastMessage }}\n\n*Resposta da Sofia:*\n{{ $('Process Response').item.json.responseMessage }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâœ… _Por favor, entre em contato com o lead para finalizar o agendamento._",
        "operation": "send",
        "phoneNumberId": "={{ $('Process Response').item.json.phoneNumberId }}",
        "requestOptions": {},
        "additionalFields": {
          "previewUrl": false
        },
        "recipientPhoneNumber": "5511972433887"
      },
      "credentials": {
        "whatsAppApi": {
          "id": "whatsapp-creds",
          "name": "WhatsApp Business"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "get-video-media-url",
      "name": "Get Video Media URL",
      "type": "n8n-nodes-base.httpRequest",
      "position": [660, 680],
      "parameters": {
        "url": "=https://graph.facebook.com/v18.0/{{ $json.messages[0].video.id }}",
        "method": "GET",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "whatsapp-bearer-creds",
          "name": "WhatsApp Bearer Token"
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "get-audio-media-url",
      "name": "Get Audio Media URL",
      "type": "n8n-nodes-base.httpRequest",
      "position": [660, 840],
      "parameters": {
        "url": "=https://graph.facebook.com/v18.0/{{ $json.messages[0].audio.id }}",
        "method": "GET",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "whatsapp-bearer-creds",
          "name": "WhatsApp Bearer Token"
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "download-video-media",
      "name": "Download Video Media",
      "type": "n8n-nodes-base.httpRequest",
      "position": [880, 680],
      "parameters": {
        "url": "={{ $json.url }}",
        "method": "GET",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "whatsapp-bearer-creds",
          "name": "WhatsApp Bearer Token"
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "download-audio-media",
      "name": "Download Audio Media",
      "type": "n8n-nodes-base.httpRequest",
      "position": [880, 840],
      "parameters": {
        "url": "={{ $json.url }}",
        "method": "GET",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "whatsapp-bearer-creds",
          "name": "WhatsApp Bearer Token"
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "transcribe-video",
      "name": "Transcribe Video",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "position": [1100, 680],
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "binaryPropertyName": "data",
        "options": {
          "language": "pt",
          "responseFormat": "text"
        }
      },
      "credentials": {
        "openAiApi": {
          "id": "openai-creds",
          "name": "OpenAI"
        }
      },
      "typeVersion": 1.8
    },
    {
      "id": "transcribe-audio",
      "name": "Transcribe Audio",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "position": [1100, 840],
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "binaryPropertyName": "data",
        "options": {
          "language": "pt",
          "responseFormat": "text"
        }
      },
      "credentials": {
        "openAiApi": {
          "id": "openai-creds",
          "name": "OpenAI"
        }
      },
      "typeVersion": 1.8
    },
    {
      "id": "format-video-transcription",
      "name": "Format Video Transcription",
      "type": "n8n-nodes-base.code",
      "position": [1320, 680],
      "parameters": {
        "jsCode": "// Format video transcription for the AI agent\nconst transcription = $input.first().json.text || '';\nconst triggerData = $('WhatsApp Trigger').first().json;\n\n// Create message structure matching text message format\nreturn {\n  messages: [{\n    from: triggerData.messages[0].from,\n    type: 'video_transcription',\n    text: {\n      body: `[Mensagem de Video Transcrita]\\n\\n${transcription}`\n    },\n    original_type: 'video',\n    video: triggerData.messages[0].video\n  }],\n  contacts: triggerData.contacts,\n  metadata: triggerData.metadata\n};"
      },
      "typeVersion": 2
    },
    {
      "id": "format-audio-transcription",
      "name": "Format Audio Transcription",
      "type": "n8n-nodes-base.code",
      "position": [1320, 840],
      "parameters": {
        "jsCode": "// Format audio transcription for the AI agent\nconst transcription = $input.first().json.text || '';\nconst triggerData = $('WhatsApp Trigger').first().json;\n\n// Create message structure matching text message format\nreturn {\n  messages: [{\n    from: triggerData.messages[0].from,\n    type: 'audio_transcription',\n    text: {\n      body: `[Mensagem de Audio Transcrita]\\n\\n${transcription}`\n    },\n    original_type: 'audio',\n    audio: triggerData.messages[0].audio\n  }],\n  contacts: triggerData.contacts,\n  metadata: triggerData.metadata\n};"
      },
      "typeVersion": 2
    },
    {
      "id": "sticky-note-main",
      "name": "Main Workflow Info",
      "type": "n8n-nodes-base.stickyNote",
      "position": [120, 60],
      "parameters": {
        "color": 7,
        "width": 520,
        "height": 260,
        "content": "## Sofia - Lead Qualification Bot (Claude Haiku 4.5)\n\nThis workflow qualifies leads from Meta Ads:\n\n1. **Receives** WhatsApp messages from Meta Ads leads\n2. **Transcribes** video and audio messages using OpenAI Whisper\n3. **Qualifies** leads through natural conversation\n4. **Guides** them to schedule a consultation\n5. **Notifies** human support when lead is ready to schedule\n\n### Environment Variable Required:\n`HUMAN_SUPPORT_PHONE` - WhatsApp number for human support notifications\n\n### Credentials Required:\n- WhatsApp Business API credentials\n- OpenAI API key (for Whisper transcription + embeddings)\n- `whatsapp-bearer-creds` - HTTP Header Auth for media download\n\n### Prerequisites:\nRun **Sofia Knowledge Base - RAG Setup** workflow first."
      },
      "typeVersion": 1
    },
    {
      "id": "sticky-note-handoff",
      "name": "Handoff Info",
      "type": "n8n-nodes-base.stickyNote",
      "position": [1460, 60],
      "parameters": {
        "color": 5,
        "width": 320,
        "height": 160,
        "content": "### Human Handoff\nWhen Sofia detects the lead wants to schedule:\n1. Sends response to lead\n2. Notifies human support via WhatsApp\n3. Support team contacts lead to finalize scheduling"
      },
      "typeVersion": 1
    },
    {
      "id": "sticky-note-ai-agent",
      "name": "AI Agent Info",
      "type": "n8n-nodes-base.stickyNote",
      "position": [560, 140],
      "parameters": {
        "color": 7,
        "width": 320,
        "height": 180,
        "content": "## Sofia AI Agent\n\n- **Claude Haiku 4.5** for fast responses\n- **50 messages** conversation memory\n- **RAG** for accurate clinic info\n- Uses `[AGENDAR_CONSULTA]` tag to trigger handoff"
      },
      "typeVersion": 1
    },
    {
      "id": "sticky-note-transcription",
      "name": "Transcription Info",
      "type": "n8n-nodes-base.stickyNote",
      "position": [560, 600],
      "parameters": {
        "color": 6,
        "width": 380,
        "height": 200,
        "content": "### Video & Audio Transcription\n\n**Supported formats:**\n- Video messages (WhatsApp video)\n- Audio messages (voice notes)\n\n**How it works:**\n1. Detects video/audio message type\n2. Downloads media from WhatsApp Cloud API\n3. Transcribes using **OpenAI Whisper** (Portuguese)\n4. Passes transcription to Sofia AI Agent\n\n**Requires:** `whatsapp-bearer-creds` credential with WhatsApp access token"
      },
      "typeVersion": 1
    },
    {
      "id": "sticky-note-qdrant",
      "name": "Qdrant Info",
      "type": "n8n-nodes-base.stickyNote",
      "position": [860, 1000],
      "parameters": {
        "color": 5,
        "width": 400,
        "height": 100,
        "content": "### Persistent Vector Store (Qdrant)\nUses the `clinic_knowledge_base` collection populated by the embedding script or **Sofia Knowledge Base - RAG Setup** workflow. Data persists across n8n restarts."
      },
      "typeVersion": 1
    }
  ],
  "connections": {
    "WhatsApp Trigger": {
      "main": [
        [
          {
            "node": "Handle Message Types",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Message Types": {
      "main": [
        [
          {
            "node": "Sofia AI Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Video Media URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Audio Media URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reply Unsupported Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Video Media URL": {
      "main": [
        [
          {
            "node": "Download Video Media",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Audio Media URL": {
      "main": [
        [
          {
            "node": "Download Audio Media",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Video Media": {
      "main": [
        [
          {
            "node": "Transcribe Video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Audio Media": {
      "main": [
        [
          {
            "node": "Transcribe Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe Video": {
      "main": [
        [
          {
            "node": "Format Video Transcription",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe Audio": {
      "main": [
        [
          {
            "node": "Format Audio Transcription",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Video Transcription": {
      "main": [
        [
          {
            "node": "Sofia AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Audio Transcription": {
      "main": [
        [
          {
            "node": "Sofia AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sofia AI Agent": {
      "main": [
        [
          {
            "node": "Process Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Response": {
      "main": [
        [
          {
            "node": "Reply To User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reply To User": {
      "main": [
        [
          {
            "node": "Needs Handoff?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Needs Handoff?": {
      "main": [
        [
          {
            "node": "Notify Human Support",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Claude Haiku 4.5": {
      "ai_languageModel": [
        [
          {
            "node": "Sofia AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Window Buffer Memory": {
      "ai_memory": [
        [
          {
            "node": "Sofia AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Knowledge Base RAG Tool": {
      "ai_tool": [
        [
          {
            "node": "Sofia AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Qdrant Vector Store": {
      "ai_vectorStore": [
        [
          {
            "node": "Knowledge Base RAG Tool",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Embeddings": {
      "ai_embedding": [
        [
          {
            "node": "Qdrant Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model (Vector Store)": {
      "ai_languageModel": [
        [
          {
            "node": "Knowledge Base RAG Tool",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "Sofia",
      "id": "1"
    },
    {
      "name": "WhatsApp",
      "id": "2"
    },
    {
      "name": "AI Agent",
      "id": "3"
    },
    {
      "name": "RAG",
      "id": "4"
    },
    {
      "name": "Haiku",
      "id": "5"
    },
    {
      "name": "Lead Qualification",
      "id": "6"
    }
  ],
  "pinData": {}
}
