{
  "name": "Sofia Alternative Flow - WhatsApp AI Assistant",
  "meta": {
    "instanceId": "sofia-alternative-flow-haiku",
    "templateCredsSetupCompleted": true
  },
  "nodes": [
    {
      "id": "whatsapp-trigger",
      "name": "WhatsApp Trigger",
      "type": "n8n-nodes-base.whatsAppTrigger",
      "position": [220, 340],
      "webhookId": "sofia-whatsapp-webhook",
      "parameters": {
        "updates": ["messages"]
      },
      "credentials": {
        "whatsAppTriggerApi": {
          "id": "whatsapp-trigger-creds",
          "name": "WhatsApp Business API"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "handle-message-types",
      "name": "Handle Message Types",
      "type": "n8n-nodes-base.switch",
      "position": [440, 340],
      "parameters": {
        "rules": {
          "values": [
            {
              "outputKey": "Text Message",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "text"
                  }
                ]
              },
              "renameOutput": true
            },
            {
              "outputKey": "Video Message",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "video"
                  }
                ]
              },
              "renameOutput": true
            },
            {
              "outputKey": "Audio Message",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "audio"
                  }
                ]
              },
              "renameOutput": true
            },
            {
              "outputKey": "Unsupported",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "or",
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "image"
                  },
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "sticker"
                  },
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "document"
                  },
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "location"
                  },
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "contacts"
                  }
                ]
              },
              "renameOutput": true
            }
          ]
        },
        "options": {}
      },
      "typeVersion": 3.2
    },
    {
      "id": "reply-unsupported",
      "name": "Reply Unsupported Type",
      "type": "n8n-nodes-base.whatsApp",
      "position": [660, 520],
      "parameters": {
        "textBody": "Ola! üíö No momento, consigo processar mensagens de texto, audio e video. Por favor, envie sua pergunta em um desses formatos e terei prazer em ajudar!",
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger').item.json.metadata?.phone_number_id }}",
        "requestOptions": {},
        "additionalFields": {
          "previewUrl": false
        },
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}"
      },
      "credentials": {
        "whatsAppApi": {
          "id": "whatsapp-creds",
          "name": "WhatsApp Business"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "sofia-ai-agent",
      "name": "Sofia AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [660, 340],
      "parameters": {
        "text": "={{ $json.messages[0].text.body }}",
        "options": {
          "systemMessage": "# Sofia - Assistente Virtual\n\nVoce e Sofia, assistente virtual de uma clinica de emagrecimento. Voce atende leads de Meta Ads quando o atendimento humano nao esta disponivel.\n\n## Contexto\n- Telefone: {{ $json.messages[0].from }}\n- Nome: {{ $json.contacts?.[0]?.profile?.name || 'Visitante' }}\n\n## Comportamento\n- Sempre se apresente como assistente virtual\n- Informe que o usuario pode solicitar atendimento humano a qualquer momento\n- Profissional, acolhedora, concisa\n- SEM emojis\n- Mensagens curtas (max 2 paragrafos)\n- Nunca seja insistente\n\n## Ferramenta RAG - IMPORTANTE\n**SEMPRE use query_knowledge_base para:**\n- Protocolos e tratamentos\n- Informacoes sobre a clinica\n- Precos e valores\n- Metodologia\n- Qualquer duvida tecnica ou institucional\n\nNunca invente informacoes.\n\n## Precos\n- Consulta (R$700): Pode mencionar apos gerar valor\n- Tratamento: Se perguntado, diga \"A partir de R$3.000 para protocolo de 1 mes\"\n- Para mais detalhes: \"O investimento varia conforme duracao e protocolo. Na consulta o medico avalia seu caso.\"\n\n## Dados a Coletar\nColete naturalmente: Nome, CPF, Email, CEP, Data nascimento, Como nos conheceu.\nIdade < 16: recuse educadamente.\n\n## Primeira Mensagem\n\"Ola! Sou a Sofia, assistente virtual da clinica. Estou aqui para ajudar com informacoes sobre nossos tratamentos e agendar sua consulta. Se preferir, pode solicitar atendimento humano a qualquer momento. Como posso ajudar?\"\n\n## Agendamento\nQuando interessado em agendar, peca:\n\"Para agendar, preciso de: Nome completo, CPF, Data de nascimento, Email, Endereco com CEP. Pode enviar como preferir.\"\n\nApos coletar (mesmo parcialmente apos 2 tentativas):\n\"Perfeito! Vou transferir para nossa equipe confirmar o horario.\n\n[DADOS_LEAD]\nNOME_COMPLETO: [dado ou 'Nao informado']\nTELEFONE: {{ $json.messages[0].from }}\nCPF: [dado ou 'Nao informado']\nDATA_NASCIMENTO: [dado ou 'Nao informado']\nEMAIL: [dado ou 'Nao informado']\nENDERECO: [dado ou 'Nao informado']\n[/DADOS_LEAD]\n[AGENDAR_CONSULTA]\"\n\n## Escalacao Humana [TRANSFERIR_HUMANO]\nEscale IMEDIATAMENTE quando:\n- Usuario solicita atendimento humano (qualquer variacao)\n- Gravidez/amamentacao\n- Condicoes serias (diabetes, cardiaco)\n- Usuario frustrado\n\n## Objecoes\n\"E caro\" -> \"Compreendo. O diferencial esta no acompanhamento continuo e retornos inclusos.\"\n\"Ja tentei de tudo\" -> \"Entendo. Aqui usamos medicina do emagrecimento com medicamentos de ultima geracao. Nao e dieta, e ciencia.\"\n\"Funciona?\" -> \"Usamos protocolos medicos com medicamentos aprovados pela ANVISA. Cada caso e unico.\""
        },
        "promptType": "define"
      },
      "typeVersion": 1.6
    },
    {
      "id": "haiku-model",
      "name": "Claude Haiku 4.5",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "position": [660, 560],
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "claude-haiku-4-5-20241022",
          "mode": "list"
        },
        "options": {
          "maxTokensToSample": 1024,
          "temperature": 0.7
        }
      },
      "credentials": {
        "anthropicApi": {
          "id": "anthropic-creds",
          "name": "Anthropic"
        }
      },
      "typeVersion": 1.2
    },
    {
      "id": "window-buffer-memory",
      "name": "Window Buffer Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "position": [800, 560],
      "parameters": {
        "sessionKey": "=sofia-whatsapp-{{ $json.messages[0].from }}",
        "sessionIdType": "customKey",
        "contextWindowLength": 50
      },
      "typeVersion": 1.2
    },
    {
      "id": "vector-store-tool",
      "name": "Knowledge Base RAG Tool",
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "position": [940, 560],
      "parameters": {
        "name": "query_knowledge_base",
        "description": "Use this tool to search the clinic's knowledge base for information about treatments, pricing, methodology, FAQ, objections handling, and compliance. Always search when the user asks about the clinic, treatments, prices, procedures, or has objections.",
        "topK": 4
      },
      "typeVersion": 1
    },
    {
      "id": "qdrant-vector-store",
      "name": "Qdrant Vector Store",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreQdrant",
      "position": [940, 740],
      "parameters": {
        "qdrantCollection": {
          "__rl": true,
          "value": "clinic_knowledge_base",
          "mode": "list"
        },
        "options": {}
      },
      "credentials": {
        "qdrantApi": {
          "id": "qdrant-creds",
          "name": "Qdrant"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "embeddings-openai",
      "name": "OpenAI Embeddings",
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "position": [1080, 740],
      "parameters": {
        "model": "text-embedding-3-small",
        "options": {}
      },
      "credentials": {
        "openAiApi": {
          "id": "openai-creds",
          "name": "OpenAI"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "openai-model-vectorstore",
      "name": "OpenAI Chat Model (Vector Store)",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [1220, 740],
      "parameters": {
        "model": "gpt-4o-mini",
        "options": {}
      },
      "credentials": {
        "openAiApi": {
          "id": "openai-creds",
          "name": "OpenAI"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "process-response",
      "name": "Process Response",
      "type": "n8n-nodes-base.code",
      "position": [900, 340],
      "parameters": {
        "jsCode": "// Process Sofia's response and detect handoff triggers\nconst agentOutput = $input.first().json.output || '';\nconst triggerData = $('WhatsApp Trigger').first().json;\n\n// Check for scheduling handoff tag\nconst needsScheduling = agentOutput.includes('[AGENDAR_CONSULTA]');\nconst needsHumanTransfer = agentOutput.includes('[TRANSFERIR_HUMANO]');\n\n// Extract lead data block if present\nlet leadData = {\n  nomeCompleto: '',\n  telefone: '',\n  cpf: '',\n  dataNascimento: '',\n  email: '',\n  endereco: ''\n};\n\nconst dataBlockMatch = agentOutput.match(/\\[DADOS_LEAD\\]([\\s\\S]*?)\\[\\/DADOS_LEAD\\]/);\nif (dataBlockMatch) {\n  const dataBlock = dataBlockMatch[1];\n  \n  // Parse each field\n  const nomeMatch = dataBlock.match(/NOME_COMPLETO:\\s*(.+?)(?:\\n|$)/);\n  const telefoneMatch = dataBlock.match(/TELEFONE:\\s*(.+?)(?:\\n|$)/);\n  const cpfMatch = dataBlock.match(/CPF:\\s*(.+?)(?:\\n|$)/);\n  const dataMatch = dataBlock.match(/DATA_NASCIMENTO:\\s*(.+?)(?:\\n|$)/);\n  const emailMatch = dataBlock.match(/EMAIL:\\s*(.+?)(?:\\n|$)/);\n  const enderecoMatch = dataBlock.match(/ENDERECO:\\s*(.+?)(?:\\n|$)/);\n  \n  leadData.nomeCompleto = nomeMatch ? nomeMatch[1].trim() : '';\n  leadData.telefone = telefoneMatch ? telefoneMatch[1].trim() : '';\n  leadData.cpf = cpfMatch ? cpfMatch[1].trim() : '';\n  leadData.dataNascimento = dataMatch ? dataMatch[1].trim() : '';\n  leadData.email = emailMatch ? emailMatch[1].trim() : '';\n  leadData.endereco = enderecoMatch ? enderecoMatch[1].trim() : '';\n}\n\n// Remove the tags and data block from the message sent to user\nlet cleanMessage = agentOutput\n  .replace(/\\[DADOS_LEAD\\][\\s\\S]*?\\[\\/DADOS_LEAD\\]/g, '')\n  .replace('[AGENDAR_CONSULTA]', '')\n  .replace('[TRANSFERIR_HUMANO]', '')\n  .trim();\n\n// Get lead info from WhatsApp\nconst whatsappPhone = triggerData.messages?.[0]?.from || 'Desconhecido';\nconst whatsappName = triggerData.contacts?.[0]?.profile?.name || 'Lead';\nconst leadMessage = triggerData.messages?.[0]?.text?.body || '';\n\n// Use collected data or fallback to WhatsApp data\nconst finalLeadData = {\n  nomeCompleto: leadData.nomeCompleto || whatsappName,\n  telefone: leadData.telefone || whatsappPhone,\n  cpf: leadData.cpf || 'Nao informado',\n  dataNascimento: leadData.dataNascimento || 'Nao informado',\n  email: leadData.email || 'Nao informado',\n  endereco: leadData.endereco || 'Nao informado'\n};\n\nreturn {\n  // Message to send to lead\n  responseMessage: cleanMessage,\n  \n  // Lead qualification data\n  leadData: finalLeadData,\n  \n  // Basic info\n  leadPhone: whatsappPhone,\n  leadName: finalLeadData.nomeCompleto,\n  lastMessage: leadMessage,\n  \n  // Handoff flags\n  needsScheduling: needsScheduling,\n  needsHumanTransfer: needsHumanTransfer,\n  needsHandoff: needsScheduling || needsHumanTransfer,\n  \n  // Handoff type for notification\n  handoffType: needsScheduling ? 'AGENDAMENTO' : (needsHumanTransfer ? 'TRANSFERENCIA' : null),\n  \n  // WhatsApp metadata\n  phoneNumberId: triggerData.metadata?.phone_number_id\n};"
      },
      "typeVersion": 2
    },
    {
      "id": "reply-to-user",
      "name": "Reply To User",
      "type": "n8n-nodes-base.whatsApp",
      "position": [1120, 340],
      "parameters": {
        "textBody": "={{ $json.responseMessage }}",
        "operation": "send",
        "phoneNumberId": "={{ $json.phoneNumberId }}",
        "requestOptions": {},
        "additionalFields": {
          "previewUrl": false
        },
        "recipientPhoneNumber": "={{ $json.leadPhone }}"
      },
      "credentials": {
        "whatsAppApi": {
          "id": "whatsapp-creds",
          "name": "WhatsApp Business"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "check-handoff",
      "name": "Needs Handoff?",
      "type": "n8n-nodes-base.if",
      "position": [1340, 340],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-handoff-flag",
              "leftValue": "={{ $('Process Response').item.json.needsHandoff }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "typeVersion": 2
    },
    {
      "id": "notify-human-support",
      "name": "Notify Human Support",
      "type": "n8n-nodes-base.whatsApp",
      "position": [1560, 240],
      "parameters": {
        "textBody": "=üîî *NOVO LEAD PRONTO PARA {{ $('Process Response').item.json.handoffType }}*\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìã *DADOS DO LEAD*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüë§ *Nome Completo:*\n{{ $('Process Response').item.json.leadData.nomeCompleto }}\n\nüì± *Telefone:*\n{{ $('Process Response').item.json.leadData.telefone }}\n\nü™™ *CPF:*\n{{ $('Process Response').item.json.leadData.cpf }}\n\nüéÇ *Data de Nascimento:*\n{{ $('Process Response').item.json.leadData.dataNascimento }}\n\nüìß *Email:*\n{{ $('Process Response').item.json.leadData.email }}\n\nüìç *Endereco com CEP:*\n{{ $('Process Response').item.json.leadData.endereco }}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüí¨ *CONVERSA*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n*Ultima mensagem do lead:*\n{{ $('Process Response').item.json.lastMessage }}\n\n*Resposta da Sofia:*\n{{ $('Process Response').item.json.responseMessage }}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚úÖ _Por favor, entre em contato com o lead para finalizar o agendamento._",
        "operation": "send",
        "phoneNumberId": "={{ $('Process Response').item.json.phoneNumberId }}",
        "requestOptions": {},
        "additionalFields": {
          "previewUrl": false
        },
        "recipientPhoneNumber": "5511972433887"
      },
      "credentials": {
        "whatsAppApi": {
          "id": "whatsapp-creds",
          "name": "WhatsApp Business"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "get-video-media-url",
      "name": "Get Video Media URL",
      "type": "n8n-nodes-base.httpRequest",
      "position": [660, 680],
      "parameters": {
        "url": "=https://graph.facebook.com/v18.0/{{ $json.messages[0].video.id }}",
        "method": "GET",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "whatsapp-bearer-creds",
          "name": "WhatsApp Bearer Token"
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "get-audio-media-url",
      "name": "Get Audio Media URL",
      "type": "n8n-nodes-base.httpRequest",
      "position": [660, 840],
      "parameters": {
        "url": "=https://graph.facebook.com/v18.0/{{ $json.messages[0].audio.id }}",
        "method": "GET",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "whatsapp-bearer-creds",
          "name": "WhatsApp Bearer Token"
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "download-video-media",
      "name": "Download Video Media",
      "type": "n8n-nodes-base.httpRequest",
      "position": [880, 680],
      "parameters": {
        "url": "={{ $json.url }}",
        "method": "GET",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "whatsapp-bearer-creds",
          "name": "WhatsApp Bearer Token"
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "download-audio-media",
      "name": "Download Audio Media",
      "type": "n8n-nodes-base.httpRequest",
      "position": [880, 840],
      "parameters": {
        "url": "={{ $json.url }}",
        "method": "GET",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "whatsapp-bearer-creds",
          "name": "WhatsApp Bearer Token"
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "transcribe-video",
      "name": "Transcribe Video",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "position": [1100, 680],
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "binaryPropertyName": "data",
        "options": {
          "language": "pt",
          "responseFormat": "text"
        }
      },
      "credentials": {
        "openAiApi": {
          "id": "openai-creds",
          "name": "OpenAI"
        }
      },
      "typeVersion": 1.8
    },
    {
      "id": "transcribe-audio",
      "name": "Transcribe Audio",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "position": [1100, 840],
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "binaryPropertyName": "data",
        "options": {
          "language": "pt",
          "responseFormat": "text"
        }
      },
      "credentials": {
        "openAiApi": {
          "id": "openai-creds",
          "name": "OpenAI"
        }
      },
      "typeVersion": 1.8
    },
    {
      "id": "format-video-transcription",
      "name": "Format Video Transcription",
      "type": "n8n-nodes-base.code",
      "position": [1320, 680],
      "parameters": {
        "jsCode": "// Format video transcription for the AI agent\nconst transcription = $input.first().json.text || '';\nconst triggerData = $('WhatsApp Trigger').first().json;\n\n// Create message structure matching text message format\nreturn {\n  messages: [{\n    from: triggerData.messages[0].from,\n    type: 'video_transcription',\n    text: {\n      body: `[Mensagem de Video Transcrita]\\n\\n${transcription}`\n    },\n    original_type: 'video',\n    video: triggerData.messages[0].video\n  }],\n  contacts: triggerData.contacts,\n  metadata: triggerData.metadata\n};"
      },
      "typeVersion": 2
    },
    {
      "id": "format-audio-transcription",
      "name": "Format Audio Transcription",
      "type": "n8n-nodes-base.code",
      "position": [1320, 840],
      "parameters": {
        "jsCode": "// Format audio transcription for the AI agent\nconst transcription = $input.first().json.text || '';\nconst triggerData = $('WhatsApp Trigger').first().json;\n\n// Create message structure matching text message format\nreturn {\n  messages: [{\n    from: triggerData.messages[0].from,\n    type: 'audio_transcription',\n    text: {\n      body: `[Mensagem de Audio Transcrita]\\n\\n${transcription}`\n    },\n    original_type: 'audio',\n    audio: triggerData.messages[0].audio\n  }],\n  contacts: triggerData.contacts,\n  metadata: triggerData.metadata\n};"
      },
      "typeVersion": 2
    },
    {
      "id": "sticky-note-main",
      "name": "Main Workflow Info",
      "type": "n8n-nodes-base.stickyNote",
      "position": [120, 60],
      "parameters": {
        "color": 7,
        "width": 520,
        "height": 260,
        "content": "## Sofia - Lead Qualification Bot (Claude Haiku 4.5)\n\nThis workflow qualifies leads from Meta Ads:\n\n1. **Receives** WhatsApp messages from Meta Ads leads\n2. **Transcribes** video and audio messages using OpenAI Whisper\n3. **Qualifies** leads through natural conversation\n4. **Guides** them to schedule a consultation\n5. **Notifies** human support when lead is ready to schedule\n\n### Environment Variable Required:\n`HUMAN_SUPPORT_PHONE` - WhatsApp number for human support notifications\n\n### Credentials Required:\n- WhatsApp Business API credentials\n- OpenAI API key (for Whisper transcription + embeddings)\n- `whatsapp-bearer-creds` - HTTP Header Auth for media download\n\n### Prerequisites:\nRun **Sofia Knowledge Base - RAG Setup** workflow first."
      },
      "typeVersion": 1
    },
    {
      "id": "sticky-note-handoff",
      "name": "Handoff Info",
      "type": "n8n-nodes-base.stickyNote",
      "position": [1460, 60],
      "parameters": {
        "color": 5,
        "width": 320,
        "height": 160,
        "content": "### Human Handoff\nWhen Sofia detects the lead wants to schedule:\n1. Sends response to lead\n2. Notifies human support via WhatsApp\n3. Support team contacts lead to finalize scheduling"
      },
      "typeVersion": 1
    },
    {
      "id": "sticky-note-ai-agent",
      "name": "AI Agent Info",
      "type": "n8n-nodes-base.stickyNote",
      "position": [560, 140],
      "parameters": {
        "color": 7,
        "width": 320,
        "height": 180,
        "content": "## Sofia AI Agent\n\n- **Claude Haiku 4.5** for fast responses\n- **50 messages** conversation memory\n- **RAG** for accurate clinic info\n- Uses `[AGENDAR_CONSULTA]` tag to trigger handoff"
      },
      "typeVersion": 1
    },
    {
      "id": "sticky-note-transcription",
      "name": "Transcription Info",
      "type": "n8n-nodes-base.stickyNote",
      "position": [560, 600],
      "parameters": {
        "color": 6,
        "width": 380,
        "height": 200,
        "content": "### Video & Audio Transcription\n\n**Supported formats:**\n- Video messages (WhatsApp video)\n- Audio messages (voice notes)\n\n**How it works:**\n1. Detects video/audio message type\n2. Downloads media from WhatsApp Cloud API\n3. Transcribes using **OpenAI Whisper** (Portuguese)\n4. Passes transcription to Sofia AI Agent\n\n**Requires:** `whatsapp-bearer-creds` credential with WhatsApp access token"
      },
      "typeVersion": 1
    },
    {
      "id": "sticky-note-qdrant",
      "name": "Qdrant Info",
      "type": "n8n-nodes-base.stickyNote",
      "position": [860, 1000],
      "parameters": {
        "color": 5,
        "width": 400,
        "height": 100,
        "content": "### Persistent Vector Store (Qdrant)\nUses the `clinic_knowledge_base` collection populated by the embedding script or **Sofia Knowledge Base - RAG Setup** workflow. Data persists across n8n restarts."
      },
      "typeVersion": 1
    }
  ],
  "connections": {
    "WhatsApp Trigger": {
      "main": [
        [
          {
            "node": "Handle Message Types",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Message Types": {
      "main": [
        [
          {
            "node": "Sofia AI Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Video Media URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Audio Media URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reply Unsupported Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Video Media URL": {
      "main": [
        [
          {
            "node": "Download Video Media",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Audio Media URL": {
      "main": [
        [
          {
            "node": "Download Audio Media",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Video Media": {
      "main": [
        [
          {
            "node": "Transcribe Video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Audio Media": {
      "main": [
        [
          {
            "node": "Transcribe Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe Video": {
      "main": [
        [
          {
            "node": "Format Video Transcription",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe Audio": {
      "main": [
        [
          {
            "node": "Format Audio Transcription",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Video Transcription": {
      "main": [
        [
          {
            "node": "Sofia AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Audio Transcription": {
      "main": [
        [
          {
            "node": "Sofia AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sofia AI Agent": {
      "main": [
        [
          {
            "node": "Process Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Response": {
      "main": [
        [
          {
            "node": "Reply To User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reply To User": {
      "main": [
        [
          {
            "node": "Needs Handoff?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Needs Handoff?": {
      "main": [
        [
          {
            "node": "Notify Human Support",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Claude Haiku 4.5": {
      "ai_languageModel": [
        [
          {
            "node": "Sofia AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Window Buffer Memory": {
      "ai_memory": [
        [
          {
            "node": "Sofia AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Knowledge Base RAG Tool": {
      "ai_tool": [
        [
          {
            "node": "Sofia AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Qdrant Vector Store": {
      "ai_vectorStore": [
        [
          {
            "node": "Knowledge Base RAG Tool",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Embeddings": {
      "ai_embedding": [
        [
          {
            "node": "Qdrant Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model (Vector Store)": {
      "ai_languageModel": [
        [
          {
            "node": "Knowledge Base RAG Tool",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "Sofia",
      "id": "1"
    },
    {
      "name": "WhatsApp",
      "id": "2"
    },
    {
      "name": "AI Agent",
      "id": "3"
    },
    {
      "name": "RAG",
      "id": "4"
    },
    {
      "name": "Haiku",
      "id": "5"
    },
    {
      "name": "Lead Qualification",
      "id": "6"
    }
  ],
  "pinData": {}
}
